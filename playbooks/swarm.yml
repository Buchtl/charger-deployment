---
- hosts: swarm
  gather_facts: no
  tasks:
    - name: Get Docker node name (usually same as hostname)
      command: hostname
      register: node_name

    - name: Label Docker Swarm node as manager
      community.docker.docker_node:
        hostname: "{{ node_name.stdout }}"
        labels_state: replace
        labels:
          manager: "true"
          database: "true"
          apps: "true"

- name: Create secret for cert key
  hosts: manager
  become: true
  vars:
    secret_state: "present"
    secret_name: "cert_key"
  tasks:
    - name: Set secret_value fact from vault
      set_fact:
        secret_value: "{{ cert_key }}"
    - name: Setup postgres docker secrets
      include_role:
        name: swarm
        tasks_from: docker_secret

- name: Create secret for cert
  hosts: manager
  become: true
  vars:
    secret_state: "present"
    secret_name: "cert"
  tasks:
    - name: Set secret_value fact from vault
      set_fact:
        secret_value: "{{ cert }}"
    - name: Setup postgres docker secrets
      include_role:
        name: swarm
        tasks_from: docker_secret

- name: Create networks charger-net
  hosts: swarm
  become: true
  vars:
    network_name: "charger-net"

  tasks:
    - name: Setup network "charger-net"
      include_role:
        name: swarm
        tasks_from: docker_network